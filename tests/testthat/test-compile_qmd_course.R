# WARNING - Generated by {fusen} from dev/flat_compile_qmd_course.Rmd: do not edit by hand

# list example qmds
courses_path <- system.file(
  "courses",
  "M01",
  package = "squash"
)

qmds <- list.files(
  path = courses_path,
  full.names = TRUE,
  recursive = TRUE,
  pattern = "qmd$"
)

# generate html in temp folder
temp_dir <- tempfile(pattern = "compile")

# list files present before rendering
file_present_before_rendering <- list.files(
  path = courses_path,
  full.names = TRUE,
  include.dirs = TRUE,
  recursive = TRUE
)

test_that("compile_qmd_course fails gracefully in case of incorrect inputs", {
  # add path to a html file in list
  qmds_with_missing_path <- c(
    qmds[[1]],
    gsub("\\.qmd", ".html", qmds[[2]])
  )
  
  #' @description test cli_message in case of error in input file type
  compile_qmd_course(
        vec_qmd_path = qmds_with_missing_path,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      ) |> 
    expect_error("Some of the input files are not qmd files.")
})

test_that("compile_qmd_course renders all input courses inside a unique html output", {
  
  # run function
  html_output <- compile_qmd_course(
    vec_qmd_path = qmds,
    output_dir = temp_dir,
    output_html = "complete_course.html"
  )
  
  file_present_after_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  #' @description test that no remaining output files are present
  expect_setequal(
    object = file_present_after_rendering,
    expected = file_present_before_rendering
  )
    
  #' @description test that output html exists
  expect_true(file.exists(html_output))
  
  img_path <- file.path(
    dirname(html_output),
    c(
      "complete_course_img/M01S01_img/img/logo_1.png",
      "complete_course_img/M01S01_img/img/logo_2.png",
      "complete_course_img/M01S02_img/img/logo_1.png"
      )
    )

  expected_md5 <- c(
    "ac99473759dd46bf0564047e5cfc2714", 
    "8d77c0f9921459b6fdc64f2cceb7c575", 
    "3b740309e3746c97e95df575801e3253"
    )
  
  #' @description test that output image exist and are the correct ones
  expect_true(all(file.exists(img_path)))
  expect_true(all(tools::md5sum(img_path) == expected_md5))
  
  slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    as.character()
  
  #' @description test html slide content is correct
  expect_snapshot(x = slide_content)

})

test_that("compile_qmd_course HTML preview looks ok", {
  
  # manual check on interactive mode only
  skip_if_not(interactive())
  take_a_look <- yesno::yesno2("\nReady to look at the html preview ?")
  
  if (isTRUE(take_a_look)) {
    cat("Buckle up, html will open in a new pane, come back to this session for validation")
    Sys.sleep(3)
    browseURL(file.path(temp_dir, "complete_course.html"))
    
    questions <- c(
      "\nYou have 11 slides, all with footer and logo ?",
      "\nMain titles are centered, all titles are orange ?",
      "\nImage and code chunk appear properly sized and colored ?"
      )
    
    answers <- sapply(
      X = questions,
      FUN = yesno::yesno2
      )
    
    cat("\nThank you :) resuming tests\n")
    
    #' @description testing all visual checks are ok from user answers
    expect_true(all(answers))
  }
})

test_that("compile_qmd_course works with non-default parameters", {

  # run function with other template and parameters
  html_output <- compile_qmd_course(
    vec_qmd_path = qmds[1],
    output_dir = temp_dir,
    output_html = "formation_R.html",
    template = system.file("template_minimal.qmd", package = "squash"),
    title = "Trouloulou",
    date = "66/66/66-66/66/66",
    trainer = "Tralala",
    mail = "Trili@li",
    phone = "+33 6 66 66 66 66"
  )

  #' @description test output has expected name
  expect_true(
    file.exists(
      file.path(temp_dir, "formation_R.html")
    )
  )
  
  first_slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    _[[1]] |> 
    as.character()
  
  #' @description test non-default info are well inserted in minimal template
  expect_snapshot(x = first_slide_content)
  
})

# clean up
unlink(temp_dir, recursive = TRUE)
