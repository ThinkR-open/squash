# WARNING - Generated by {fusen} from /dev/flat_compile_qmd_course.Rmd: do not edit by hand

test_that("compile_qmd_course works", {
  # list example qmds
  courses_path <- system.file(
    "courses",
    package = "nq1h"
  )
  
  qmds <- list.files(
    path = courses_path,
    full.names = TRUE,
    recursive = TRUE,
    pattern = "qmd$"
  )
  
  qmds_with_missing_path <- c(
    qmds[[1]],
    "a_path_to_a_qmd_that_does_not_exists.qmd"
  )
  
  # generate html in temp folder
  temp_dir <- tempfile(pattern = "compile")
  
  # list files present before rendering
  file_present_before_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  # test cli_message in case of error in rendering
  # (skip error with tryCatch to see message in test)
  expect_message(object = {
    tryCatch(expr = {
      compile_qmd_course(
        vec_qmd_path = qmds_with_missing_path,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      )
    },
    error = \(x) {}
    )
  },
  regexp = "Fail to render a_path_to_a_qmd_that_does_not_exists.qmd"
  )
  
  # test cli message in case of success
  expect_message(object = {
    html_output <- compile_qmd_course(
      vec_qmd_path = qmds,
      output_dir = temp_dir,
      output_html = "complete_course.html"
    )
  },
  regexp = "qmd1_for_test.qmd rendered successfully"
  )

  # test that no remaining output files are present
  file_present_after_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  expect_setequal(
    object = file_present_after_rendering,
    expected = file_present_before_rendering
  )
    
  # test that output html exists
  expect_true(file.exists(html_output))
  
  # test that output image exist and are the correct ones
  img_path <- file.path(
    dirname(html_output),
    c(
      "complete_course_img/C01_img/img/logo_1.png",
      "complete_course_img/C01_img/img/logo_2.png",
      "complete_course_img/C02_img/img/logo_1.png"
      )
    )
  expect_true(all(file.exists(img_path)))
  
  expected_md5 <- c(
    "ac99473759dd46bf0564047e5cfc2714", 
    "8d77c0f9921459b6fdc64f2cceb7c575", 
    "3b740309e3746c97e95df575801e3253"
    )
  expect_true(all(tools::md5sum(img_path) == expected_md5))
  
  # test html slide content is correct
  slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    as.character()
  
  expect_equal(
    object = slide_content,
    expected = c(
      "<section id=\"title-slide\" data-background-image=\"_extensions/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Formation R</h1>\n  <p class=\"subtitle\">01/01/01-01/01/01</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>",
      "<section class=\"slide level2\"><p><section id=\"title-slide-1\" class=\"quarto-title-block center\"><h1 class=\"title\">Premier Chapitre</h1>\n  <p class=\"subtitle\">alpha</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>Texte 1</p>\n</section><section id=\"slide-1-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>{dplyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-2\" class=\"quarto-title-block center\"><h1 class=\"title\">Deuxième Chapitre</h1>\n  <p class=\"subtitle\">omega</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-2\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>Texte 2</p>\n<aside class=\"notes\"><p>This is a speaker note, it is only visible in the speaker view.</p>\n<style type=\"text/css\">\n        span.MJX_Assistive_MathML {\n          position:absolute!important;\n          clip: rect(1px, 1px, 1px, 1px);\n          padding: 1px 0 0 0!important;\n          border: 0!important;\n          height: 1px!important;\n          width: 1px!important;\n          overflow: hidden!important;\n          display:block!important;\n      }</style></aside></section><section id=\"slide-2-1\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>{tidyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_2.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-3\" class=\"quarto-title-block center\"><h1 class=\"title\">Troisième Chapitre</h1>\n  <p class=\"subtitle\">youpi</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-3\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>Texte 3</p>\n</section><section id=\"slide-3-1\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>{ggplot2} image</p>\n\n<img data-src=\"complete_course_img/C02_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section></p>\n</section>",
      "<section id=\"include_trainer\" class=\"slide level2\"><h2>ThinkR</h2>\n<p><strong>+33 0 00 00 00 00</strong></p>\n<p><strong>thinkr.fr</strong></p>\n\n<img src=\"_extensions/thinkridentity/logo.png\" class=\"slide-logo r-stretch\"><div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Formation R</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>"
    )
  )
  
  # clean up
  unlink(temp_dir, recursive = TRUE)
})
