# WARNING - Generated by {fusen} from /dev/flat_compile_qmd_course.Rmd: do not edit by hand

# list example qmds
courses_path <- system.file(
  "courses",
  package = "nq1h"
)

qmds <- list.files(
  path = courses_path,
  full.names = TRUE,
  recursive = TRUE,
  pattern = "qmd$"
)

# generate html in temp folder
temp_dir <- tempfile(pattern = "compile")

# list files present before rendering
file_present_before_rendering <- list.files(
  path = courses_path,
  full.names = TRUE,
  include.dirs = TRUE,
  recursive = TRUE
)

test_that("compile_qmd_course fails gracefully in case of incorrect inputs", {
  
  # add incorrect path in qmd list
  qmds_with_missing_path <- c(
    qmds[[1]],
    "a_path_to_a_qmd_that_does_not_exists.qmd"
  )
  
  #' @description test cli_message in case of error in rendering
  compile_qmd_course(
        vec_qmd_path = qmds_with_missing_path,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      ) |> 
    expect_message("Fail to render a_path_to_a_qmd_that_does_not_exists.qmd") |> 
    expect_error()
  
  # add path to a html file in list
  qmds_with_missing_path <- c(
    qmds[[1]],
    gsub("\\.qmd", ".html", qmds[[2]])
  )
  
  #' @description test cli_message in case of error in input file type
  compile_qmd_course(
        vec_qmd_path = qmds_with_missing_path,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      ) |> 
    expect_error("Some of the input files are not qmd files.")
  
})

test_that("compile_qmd_course renders all input courses inside a unique html output", {
  #' @description test cli message in case of success
  expect_message(
    object = {
      html_output <- compile_qmd_course(
        vec_qmd_path = qmds,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      )
    }, regexp = "qmd1_for_test.qmd rendered successfully"
  )
  
  file_present_after_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  #' @description test that no remaining output files are present
  expect_setequal(
    object = file_present_after_rendering,
    expected = file_present_before_rendering
  )
    
  #' @description test that output html exists
  expect_true(file.exists(html_output))
  
  img_path <- file.path(
    dirname(html_output),
    c(
      "complete_course_img/C01_img/img/logo_1.png",
      "complete_course_img/C01_img/img/logo_2.png",
      "complete_course_img/C02_img/img/logo_1.png"
      )
    )

  expected_md5 <- c(
    "ac99473759dd46bf0564047e5cfc2714", 
    "8d77c0f9921459b6fdc64f2cceb7c575", 
    "3b740309e3746c97e95df575801e3253"
    )
  
  #' @description test that output image exist and are the correct ones
  expect_true(all(file.exists(img_path)))
  expect_true(all(tools::md5sum(img_path) == expected_md5))
  
  slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    as.character()
  
  #' @description test html slide content is correct
  expect_equal(
    object = slide_content,
    expected = c(
      "<section id=\"title-slide\" data-background-image=\"_extensions/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Formation R</h1>\n  <p class=\"subtitle\">01/01/01-01/01/01</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>",
      "<section class=\"slide level2\"><p><section id=\"title-slide-1\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Premier Chapitre</h1>\n  <p class=\"subtitle\">alpha</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>An example code chunk</p>\n<div class=\"cell\">\n<div class=\"sourceCode cell-code\" id=\"cb1\"><pre class=\"sourceCode numberSource r number-lines code-with-copy\"><code class=\"sourceCode r\"><span id=\"cb1-1\"><a href=\"#cb1-1\"></a><span class=\"dv\">8</span> <span class=\"sc\">*</span> <span class=\"dv\">8</span></span></code><button title=\"Copy to Clipboard\" class=\"code-copy-button\"><i class=\"bi\"></i></button></pre></div>\n<div class=\"cell-output cell-output-stdout\">\n<pre><code>[1] 64</code></pre>\n</div>\n</div>\n</section><section id=\"slide-1-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>{dplyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-2\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Deuxième Chapitre</h1>\n  <p class=\"subtitle\">omega</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-2\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>Texte 2</p>\n<aside class=\"notes\"><p>This is a speaker note, it is only visible in the speaker view.</p>\n<style type=\"text/css\">\n        span.MJX_Assistive_MathML {\n          position:absolute!important;\n          clip: rect(1px, 1px, 1px, 1px);\n          padding: 1px 0 0 0!important;\n          border: 0!important;\n          height: 1px!important;\n          width: 1px!important;\n          overflow: hidden!important;\n          display:block!important;\n      }</style></aside></section><section id=\"slide-2-1\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>{tidyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_2.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-3\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Troisième Chapitre</h1>\n  <p class=\"subtitle\">youpi</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-3\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>Texte 3</p>\n</section><section id=\"slide-3-1\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>{ggplot2} image</p>\n\n<img data-src=\"complete_course_img/C02_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section></p>\n</section>",
      "<section id=\"include_trainer\" class=\"slide level2\"><h2>ThinkR</h2>\n<p><strong>+33 0 00 00 00 00</strong></p>\n<p><strong>thinkr.fr</strong></p>\n\n<img src=\"_extensions/thinkridentity/logo.png\" class=\"slide-logo r-stretch\"><div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Formation R</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>"
    )
  )

})

test_that("compile_qmd_course HTML preview looks ok", {
  # manual check on interactive mode only
  skip_if_not(interactive())
  take_a_look <- yesno::yesno2("\nReady to look at the html preview ?")
  
  if (isTRUE(take_a_look)) {
    cat("Buckle up, html will open in a new pane, come back to this session for validation")
    Sys.sleep(3)
    browseURL(file.path(temp_dir, "complete_course.html"))
    
    questions <- c(
      "\nYou have 11 slides, all with footer and logo ?",
      "\nMain titles are centered, all titles are orange ?",
      "\nImage and code chunk appear properly sized and colored ?"
      )
    
    answers <- sapply(
      X = questions,
      FUN = yesno::yesno2
      )
    
    cat("\nThank you :) resuming tests\n")
    
    #' @description testing all visual checks are ok from user answers
    expect_true(all(answers))
  }
})

test_that("compile_qmd_course works with non-default parameters", {

  # run function with other template and parameters
  html_output <- compile_qmd_course(
    vec_qmd_path = qmds[1],
    output_dir = temp_dir,
    output_html = "formation_R.html",
    template = system.file("template_minimal.qmd", package = "nq1h"),
    title = "Trouloulou",
    date = "66/66/66-66/66/66",
    trainer = "Tralala",
    mail = "Trili@li",
    phone = "+33 6 66 66 66 66"
  )

  #' @description test output has expected name
  expect_true(
    file.exists(
      file.path(temp_dir, "formation_R.html")
    )
  )
  
  first_slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    _[[1]] |> 
    as.character()
  
  #' @description test non-default info are well inserted in minimal template
  expect_equal(
    object = first_slide_content,
    expected = "<section id=\"title-slide\" data-background-image=\"_extensions/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Trouloulou</h1>\n  <p class=\"subtitle\">66/66/66-66/66/66</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>"
    )
  
})

# clean up
unlink(temp_dir, recursive = TRUE)
