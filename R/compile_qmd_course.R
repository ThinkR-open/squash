# WARNING - Generated by {fusen} from /dev/flat_compile_qmd_course.Rmd: do not edit by hand

#' Create a single html from multiple qmd
#'
#' Independently compile several qmd and create a common html
#'
#' @param vec_qmd_path character. Vector of the path to qmd files
#' @param output_dir character. Output path to store html files and companion folders
#' @param output_html character. File name of the complete html output saved
#' @param template character. Path to the template qmd to use. Content will be included at the positions inside double-brackets
#' @param title character. Title of the presentation
#' @param date character. Start and end dates of the training
#' @param trainer character. Name of the trainer
#' @param mail character. Mail of the trainer
#' @param phone character. Phone number of the trainer
#'
#' @importFrom tools file_ext
#' @importFrom cli cat_bullet
#' @importFrom quarto quarto_render
#' @importFrom htmltools htmlTemplate renderDocument save_html
#' @importFrom cli cli_alert_success cli_alert_danger
#'
#' @return character. The path to the resulting html file
#'
#' @export
#' @examples
#' # list example qmds
#' courses_path <- system.file(
#'   "courses",
#'   package = "nq1h"
#' )
#' 
#' qmds <- list.files(
#'   path = courses_path,
#'   full.names = TRUE,
#'   recursive = TRUE,
#'   pattern = "qmd$"
#' )
#' 
#' # generate html in temp folder
#' temp_dir <- tempfile(pattern = "compile")
#' 
#' html_output <- compile_qmd_course(
#'   vec_qmd_path = qmds,
#'   output_dir = temp_dir,
#'   output_html = "complete_course.html"
#' )
#' 
#' # clean up
#' unlink(temp_dir, recursive = TRUE)
compile_qmd_course <- function(
    vec_qmd_path,
    output_dir,
    output_html,
    template = system.file("template.qmd", package = "nq1h"),
    title = "Formation R",
    date = "01/01/01-01/01/01",
    trainer = "ThinkR",
    mail = "thinkr.fr",
    phone = "+33 0 00 00 00 00"
) {
  # check paths
  not_all_files_are_qmd <- any(
    file_ext(vec_qmd_path) != "qmd"
  )
  if (isTRUE(not_all_files_are_qmd)) {
    stop("Some of the input files are not qmd files.")
  }
  
  # create output dir and html template
  template_html <- create_template_html(
    path_to_qmd = template,
    output_dir = output_dir,
    output_file = output_html,
    title = title,
    date = date
  )
  
  # list courses files present before rendering
  vec_qmd_dir <- unique(dirname(vec_qmd_path))
  
  file_present_before_rendering <- list.files(
    path = vec_qmd_dir,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  for (qmd_dir in vec_qmd_dir) {
    
    # prepare rendering params (img/ dir and qmd files)
    img_dir <- file.path(
      gsub("\\.html", "_img", output_html),
      paste0(basename(qmd_dir), "_img")
    )
    
    vec_qmd_path_group <- vec_qmd_path[dirname(vec_qmd_path) == qmd_dir]
    
    # render qmd in html in original dir
    for (qmd in vec_qmd_path_group) {
      cat_bullet(sprintf("Rendering %s", qmd))
      
      # try rendering qmd and warn user if successful / fail
      tryCatch(expr = {
        quarto_render(
          input = qmd,
          quiet = TRUE,
          # use revealjs parameter to make a copy of img dir
          # use compil quarto profile to not add logo/bg and footer from quakr
          pandoc_args = c(
            paste0("--extract-media=", img_dir),
            "--profile=compil"
          )
        )
        cli_alert_success("{basename(qmd)} rendered successfully")
      }, 
      error = \(error_message) {
        cli_alert_danger("Fail to render {qmd}, cleaning and existing")
        
        # clean rendering output
        clean_rendering_files(
          dir = vec_qmd_dir,
          present_before = file_present_before_rendering
        )
        
        # throw an error with original error message
        stop(error_message)
      })
    }
  }
  
  # read html and extract slides elements
  vec_html_path <- gsub("\\.qmd", "\\.html", vec_qmd_path)
  
  html_content <- extract_html_slides(
    vec_html_path = vec_html_path
  )
  
  # include content in template
  complete_html <- htmlTemplate(
    filename = template_html,
    include_html_content = html_content,
    include_trainer = trainer,
    include_mail = mail,
    include_phone = phone
  ) |>
    renderDocument()
  
  # save html file
  path_to_html <- file.path(
    output_dir,
    output_html
  )
  
  save_html(
    html = complete_html,
    file = path_to_html
  )
  
  # copy all img sub-folders to output_dir
  output_img_dir <- file.path(
    output_dir,
    gsub("\\.html", "_img", output_html)
  )
  
  if (!file.exists(output_img_dir)) {
    dir.create(path = output_img_dir)
  }
  
  vec_img_dir <- file.path(
    vec_qmd_dir,
    gsub("\\.html", "_img", output_html),
    paste0(basename(vec_qmd_dir), "_img")
  )
  
  file.copy(
    from = unique(vec_img_dir),
    to = output_img_dir,
    recursive = TRUE
  )
  
  clean_rendering_files(
    dir = vec_qmd_dir,
    present_before = file_present_before_rendering
  )
  
  return(
    file.path(
      output_dir,
      output_html
    )
  )
}
