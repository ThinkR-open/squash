---
title: "flat_compile_qmd_course.Rmd"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = TRUE)
```

## `compile_qmd_course()` : compile individual qmds into a combined html

```{r function-compile_qmd_course}
#' Independently compile several qmd and create a common html
#'
#' @param vec_qmd_path character. Vector of the path to qmd files
#' @param output_dir character. Output path to store html files and companion folders
#' 
#' @importFrom tools file_ext
#' @importFrom withr with_dir
#' @importFrom cli cat_bullet
#' @importFrom quarto quarto_render
#' @importFrom rvest read_html html_elements
#' 
#' @return list. A list of xml_nodeset elements extracted from each compiled html
#' 
#' @export
compile_qmd_course <- function(
    vec_qmd_path,
    output_dir
) {
  # check paths
  not_all_files_are_qmd <- any(
      file_ext(vec_qmd_path) != "qmd"
    )
  if (isTRUE(not_all_files_are_qmd)){
    stop("Some of the input files are not qmd files.")
  }

  # create output dir
  if (isFALSE(file.exists(output_dir))){
    dir.create(output_dir)
  }

  # copy qmd to render dir
  file.copy(
    from = vec_qmd_path,
    to = output_dir
  )

  # render qmd to html
  with_dir(
    output_dir,
    {
      for (qmd in basename(vec_qmd_path)){
        cat_bullet(
          sprintf("Rendering %s", qmd)
        )
        quarto_render(
          input = qmd,
          quiet = FALSE
        )
      }
    }
  )
  
  # remove qmd from render dir
  unlink(file.path(output_dir, basename(vec_qmd_path)))
  
  # read html and extract slides elements
  vec_html_path <- file.path(output_dir,
                             gsub(".qmd", ".html", basename(vec_qmd_path)))
  
  vec_html_slides <- lapply(X = vec_html_path,
                            FUN = \(x) {
                              x |>
                                read_html() |>
                                html_elements(".slides")
                            })
  
  return(vec_html_slides)
}
```

```{r examples-compile_qmd_course}

# list example qmds
courses_path <- system.file(
  "courses",
  package = "nq1h"
)

qmds <- list.files(
  path = courses_path, 
  full.names = TRUE, 
  pattern = "qmd$"
)

# generate html in temp folder
temp_dir <- tempfile(pattern = "compile") 

compile_output <- compile_qmd_course(
  vec_qmd_path = qmds,
  output_dir = temp_dir
)

# clean up
unlink(temp_dir, recursive = TRUE)

```

```{r dev-compile_qmd_course}
#---- to refactor next

# template_qmd <- readLines(
#   system.file(
#     "template.qmd",
#     package = "nq1h"
#   )
# )
# 
# path_html_files <- list.files(
#   temp_dir, 
#   full.names = TRUE,
#   pattern = "\\.html$"
# )
# 
# divs_to_insert <- path_html_files |> 
#   lapply(
#     \(path_html_file) {
#       sprintf(
#         '<div data-external-replace="%s">  </div>',
#         path_html_file
#       )
#     }
#   ) |> 
#   paste(
#     collapse = "\n\n---\n\n"
#   )
# 
# index_qmd <- gsub(
#   pattern = "\\{\\{insert_divs\\}\\}",
#   replacement = divs_to_insert,
#   template_qmd
# ) 
# 
# writeLines(
#   index_qmd,
#   "index.qmd"
# )
```


```{r tests-compile_qmd_course}
test_that("compile_qmd_course works", {
  # list example qmds
  courses_path <- system.file("courses",
                              package = "nq1h")
  
  qmds <- list.files(path = courses_path,
                     full.names = TRUE,
                     pattern = "qmd$")
  
  # generate html in temp folder
  temp_dir <- tempfile(pattern = "compile")
  
  compile_output <- compile_qmd_course(vec_qmd_path = qmds,
                                       output_dir = temp_dir)
  
  # test that html file exists
  expected_html <- file.path(temp_dir,
                             gsub(".qmd", ".html", basename(qmds)))
  expect_true(all(file.exists(expected_html)))
  
  # test that companion html folders exist
  expected_html_folders <- gsub(".html", "_files", expected_html)
  expect_true(all(file.exists(expected_html_folders)))
  
  # test that output is a list of html elements
  expect_true(inherits(compile_output, "list"))
  element_class <- lapply(compile_output, class)
  expect_true(all(element_class == "xml_nodeset"))
  
  # clean up
  unlink(temp_dir, recursive = TRUE)
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_compile_qmd_course.Rmd",
  vignette_name = "Compile n qmd to html",
  check = FALSE,
  overwrite = TRUE
  )
```

