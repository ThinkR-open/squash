---
title: "flat_compile_qmd_course.Rmd"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = TRUE)
```

## `compile_qmd_course()` : compile individual qmds into a combined html

```{r function-compile_qmd_course}
#' compile_qmd_course
#'
#' Independently compile several qmd and create a common html
#'
#' @param vec_qmd_path character. Vector of the path to qmd files
#' @param output_dir character. Output path to store html files and companion folders
#' @param output_html character. File name of the complete html output saved
#' @param template character. Path to the template qmd to use. Content will be included at the positions inside double-brackets
#' @param title character. Title of the presentation
#' @param date character. Start and end dates of the training
#' @param trainer character. Name of the trainer
#' @param mail character. Mail of the trainer
#' @param phone character. Phone number of the trainer
#'
#' @importFrom tools file_ext
#' @importFrom withr with_dir
#' @importFrom cli cat_bullet
#' @importFrom quarto quarto_render
#' @importFrom htmltools htmlTemplate renderDocument save_html
#' @importFrom cli cli_alert_success cli_alert_danger
#'
#' @return character. The path to the resulting html file
#'
#' @export
compile_qmd_course <- function(
    vec_qmd_path,
    output_dir,
    output_html,
    template = system.file("template.qmd", package = "nq1h"),
    title = "Formation R",
    date = "01/01/01-01/01/01",
    trainer = "ThinkR",
    mail = "thinkr.fr",
    phone = "+33 0 00 00 00 00"
) {
  # check paths
  not_all_files_are_qmd <- any(
    file_ext(vec_qmd_path) != "qmd"
  )
  if (isTRUE(not_all_files_are_qmd)) {
    stop("Some of the input files are not qmd files.")
  }
  
  # create output dir and html template
  template_html <- create_template_html(
    path_to_qmd = template,
    output_dir = output_dir,
    output_file = output_html,
    title = title,
    date = date
  )
  
  # list courses files present before rendering
  vec_qmd_dir <- unique(dirname(vec_qmd_path))
  
  file_present_before_rendering <- list.files(
    path = vec_qmd_dir,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  for (qmd_dir in vec_qmd_dir) {
    
    # prepare rendering params (img/ dir and qmd files)
    img_dir <- file.path(
      gsub("\\.html", "_img", output_html),
      paste0(basename(qmd_dir), "_img")
    )
    
    vec_qmd_path_group <- vec_qmd_path[dirname(vec_qmd_path) == qmd_dir]
    
    # render qmd in html in original dir
    for (qmd in vec_qmd_path_group) {
      cat_bullet(sprintf("Rendering %s", qmd))
      
      # try rendering qmd and warn user if successful / fail
      tryCatch(expr = {
        quarto_render(
          input = qmd,
          quiet = TRUE,
          # use revealjs parameter to make a copy of img dir
          # use compil quarto profile to not add logo/bg and footer from quakr
          pandoc_args = c(
            paste0("--extract-media=", img_dir),
            "--profile=compil"
          )
        )
        cli_alert_success("{basename(qmd)} rendered successfully")
      }, 
      error = \(error_message) {
        cli_alert_danger("Fail to render {qmd}, cleaning and existing")
        
        # clean rendering output
        clean_rendering_files(
          dir = vec_qmd_dir,
          present_before = file_present_before_rendering
        )
        
        # throw an error with original error message
        stop(error_message)
      })
    }
  }
  
  # read html and extract slides elements
  vec_html_path <- gsub("\\.qmd", "\\.html", vec_qmd_path)
  
  html_content <- extract_html_slides(
    vec_html_path = vec_html_path
  )
  
  # include content in template
  complete_html <- htmlTemplate(
    filename = template_html,
    include_html_content = html_content,
    include_trainer = trainer,
    include_mail = mail,
    include_phone = phone
  ) |>
    renderDocument()
  
  # save html file
  path_to_html <- file.path(
    output_dir,
    output_html
  )
  
  save_html(
    html = complete_html,
    file = path_to_html
  )
  
  # copy all img sub-folders to output_dir
  output_img_dir <- file.path(
    output_dir,
    gsub("\\.html", "_img", output_html)
  )
  
  if (!file.exists(output_img_dir)) {
    dir.create(path = output_img_dir)
  }
  
  vec_img_dir <- file.path(
    vec_qmd_dir,
    gsub("\\.html", "_img", output_html),
    paste0(basename(vec_qmd_dir), "_img")
  )
  
  file.copy(
    from = unique(vec_img_dir),
    to = output_img_dir,
    recursive = TRUE
  )
  
  clean_rendering_files(
    dir = vec_qmd_dir,
    present_before = file_present_before_rendering
  )
  
  return(
    file.path(
      output_dir,
      output_html
    )
  )
}
```

```{r examples-compile_qmd_course}
# list example qmds
courses_path <- system.file(
  "courses",
  package = "nq1h"
)

qmds <- list.files(
  path = courses_path,
  full.names = TRUE,
  recursive = TRUE,
  pattern = "qmd$"
)

# generate html in temp folder
temp_dir <- tempfile(pattern = "compile")

html_output <- compile_qmd_course(
  vec_qmd_path = qmds,
  output_dir = temp_dir,
  output_html = "complete_course.html"
)

# clean up
unlink(temp_dir, recursive = TRUE)
```

```{r tests-compile_qmd_course}
test_that("compile_qmd_course works", {
  # list example qmds
  courses_path <- system.file(
    "courses",
    package = "nq1h"
  )
  
  qmds <- list.files(
    path = courses_path,
    full.names = TRUE,
    recursive = TRUE,
    pattern = "qmd$"
  )
  
  qmds_with_missing_path <- c(
    qmds[[1]],
    "a_path_to_a_qmd_that_does_not_exists.qmd"
  )
  
  # generate html in temp folder
  temp_dir <- tempfile(pattern = "compile")
  
  # list files present before rendering
  file_present_before_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  # test cli_message in case of error in rendering
  # (skip error with tryCatch to see message in test)
  expect_message(object = {
    tryCatch(expr = {
      compile_qmd_course(
        vec_qmd_path = qmds_with_missing_path,
        output_dir = temp_dir,
        output_html = "complete_course.html"
      )
    },
    error = \(x) {}
    )
  },
  regexp = "Fail to render a_path_to_a_qmd_that_does_not_exists.qmd"
  )
  
  # test cli message in case of success
  expect_message(object = {
    html_output <- compile_qmd_course(
      vec_qmd_path = qmds,
      output_dir = temp_dir,
      output_html = "complete_course.html"
    )
  },
  regexp = "qmd1_for_test.qmd rendered successfully"
  )

  # test that no remaining output files are present
  file_present_after_rendering <- list.files(
    path = courses_path,
    full.names = TRUE,
    include.dirs = TRUE,
    recursive = TRUE
  )
  
  expect_setequal(
    object = file_present_after_rendering,
    expected = file_present_before_rendering
  )
    
  # test that output html exists
  expect_true(file.exists(html_output))
  
  # test that output image exist and are the correct ones
  img_path <- file.path(
    dirname(html_output),
    c(
      "complete_course_img/C01_img/img/logo_1.png",
      "complete_course_img/C01_img/img/logo_2.png",
      "complete_course_img/C02_img/img/logo_1.png"
      )
    )
  expect_true(all(file.exists(img_path)))
  
  expected_md5 <- c(
    "ac99473759dd46bf0564047e5cfc2714", 
    "8d77c0f9921459b6fdc64f2cceb7c575", 
    "3b740309e3746c97e95df575801e3253"
    )
  expect_true(all(tools::md5sum(img_path) == expected_md5))
  
  # test html slide content is correct
  slide_content <- html_output |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    as.character()
  
  expect_equal(
    object = slide_content,
    expected = c(
      "<section id=\"title-slide\" data-background-image=\"_extensions/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Formation R</h1>\n  <p class=\"subtitle\">01/01/01-01/01/01</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>",
      "<section class=\"slide level2\"><p><section id=\"title-slide-1\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Premier Chapitre</h1>\n  <p class=\"subtitle\">alpha</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>An example code chunk</p>\n<div class=\"cell\">\n<div class=\"sourceCode cell-code\" id=\"cb1\"><pre class=\"sourceCode numberSource r number-lines code-with-copy\"><code class=\"sourceCode r\"><span id=\"cb1-1\"><a href=\"#cb1-1\"></a><span class=\"dv\">8</span> <span class=\"sc\">*</span> <span class=\"dv\">8</span></span></code><button title=\"Copy to Clipboard\" class=\"code-copy-button\"><i class=\"bi\"></i></button></pre></div>\n<div class=\"cell-output cell-output-stdout\">\n<pre><code>[1] 64</code></pre>\n</div>\n</div>\n</section><section id=\"slide-1-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>{dplyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-2\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Deuxi√®me Chapitre</h1>\n  <p class=\"subtitle\">omega</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-2\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>Texte 2</p>\n<aside class=\"notes\"><p>This is a speaker note, it is only visible in the speaker view.</p>\n<style type=\"text/css\">\n        span.MJX_Assistive_MathML {\n          position:absolute!important;\n          clip: rect(1px, 1px, 1px, 1px);\n          padding: 1px 0 0 0!important;\n          border: 0!important;\n          height: 1px!important;\n          width: 1px!important;\n          overflow: hidden!important;\n          display:block!important;\n      }</style></aside></section><section id=\"slide-2-1\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>{tidyr} image</p>\n\n<img data-src=\"complete_course_img/C01_img/img/logo_2.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section><section id=\"title-slide-3\" data-background-image=\"\" class=\"quarto-title-block center\"><h1 class=\"title\">Troisi√®me Chapitre</h1>\n  <p class=\"subtitle\">youpi</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section><section id=\"slide-3\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>Texte 3</p>\n</section><section id=\"slide-3-1\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>{ggplot2} image</p>\n\n<img data-src=\"complete_course_img/C02_img/img/logo_1.png\" class=\"r-stretch\"><div class=\"footer footer-default\">\n\n</div>\n</section></p>\n</section>",
      "<section id=\"include_trainer\" class=\"slide level2\"><h2>ThinkR</h2>\n<p><strong>+33 0 00 00 00 00</strong></p>\n<p><strong>thinkr.fr</strong></p>\n\n<img src=\"_extensions/thinkridentity/logo.png\" class=\"slide-logo r-stretch\"><div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Formation R</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>"
    )
  )
  
  # clean up
  unlink(temp_dir, recursive = TRUE)
})
```


## `extract_html_slides()` : extract html each elements of slides from multiple html files

```{r function-extract_html_slides}
#' extract_html_slides
#'
#' Extract slide content from multiple html
#'
#' @param vec_html_path character. The vector of path to individual html files
#'
#' @importFrom tools file_ext
#' @importFrom rvest read_html html_elements html_children
#' @importFrom htmltools HTML
#'
#' @return HTML. The HTML slide content of all html files combined together.
#'
#' @export
extract_html_slides <- function(
    vec_html_path
  ) {
  # verify path are html files
  not_all_files_are_html <- any(
    file_ext(vec_html_path) != "html"
  )
  if (isTRUE(not_all_files_are_html)) {
    stop("Some of the input files are not html files.")
  }
  
  # extract all slides elements
  list_html_slides <- lapply(
    X = vec_html_path,
    FUN = \(html_path) {
      html_path |>
        read_html() |>
        html_elements(".slides") |>
        html_children() |>
        as.character()
    }
  )
  
  # rename 1st slide to avoid duplicated title-slide ids
  list_html_slides <- lapply(
    X = seq_along(list_html_slides),
    FUN = \(slide_number) {
      gsub(
        pattern = "title-slide",
        replacement = paste0("title-slide-", as.character(slide_number)),
        x = list_html_slides[[slide_number]]
      )
    }
  )
  
  # compile all slides content into a single HTML text
  html_content <- list_html_slides |>
    unlist() |>
    paste0(collapse = "\n") |>
    HTML()
  
  return(html_content)
}
```

```{r example-extract_html_slides}
# list html files
courses_path <- system.file(
  "courses",
  package = "nq1h"
)

htmls <- list.files(
  path = courses_path,
  full.names = TRUE,
  recursive = TRUE,
  pattern = "html$"
)

html_slide_content <- extract_html_slides(vec_html_path = htmls)
```

```{r tests-extract_html_slides}
test_that("extract_html_slides works", {
  # create temp dir
  temp_dir <- tempfile(pattern = "template")
  dir.create(temp_dir)
  
  # copy qmd in tmp
  nq1h_path <- system.file(package = "nq1h")

  files_to_copy <- c(
    file.path(
      nq1h_path,
      c("_extensions",
        "courses",
        "_quarto.yaml",
        "_quarto-render.yml")
    )
  )
  
  file.copy(
    from = files_to_copy,
    to = temp_dir,
    recursive = TRUE
  )
  
  # render all course qmd in quarto project with default profile
  # remove as_job to not run as background jobs
  quarto::quarto_render(
    input = temp_dir,
    as_job = FALSE
    )
  
  # list created html
  htmls <- list.files(
    path = temp_dir,
    pattern = "qmd[0-9]_for_test\\.html$",
    recursive = TRUE,
    full.names = TRUE
  )
  
  # test with three html files in order 1-2-3
  html_slide_content <- extract_html_slides(
    vec_html_path = htmls
    )
  
  expect_equal(
    object = html_slide_content,
    expected = structure(
      "<section id=\"title-slide-1\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Premier Chapitre</h1>\n  <p class=\"subtitle\">alpha</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>An example code chunk</p>\n<div class=\"cell\">\n<div class=\"sourceCode cell-code\" id=\"cb1\"><pre class=\"sourceCode numberSource r number-lines code-with-copy\"><code class=\"sourceCode r\"><span id=\"cb1-1\"><a href=\"#cb1-1\"></a><span class=\"dv\">8</span> <span class=\"sc\">*</span> <span class=\"dv\">8</span></span></code><button title=\"Copy to Clipboard\" class=\"code-copy-button\"><i class=\"bi\"></i></button></pre></div>\n<div class=\"cell-output cell-output-stdout\">\n<pre><code>[1] 64</code></pre>\n</div>\n</div>\n</section>\n<section id=\"slide-1-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>{dplyr} image</p>\n<p><img data-src=\"img/logo_1.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Premier Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>\n<section id=\"title-slide-2\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Deuxi√®me Chapitre</h1>\n  <p class=\"subtitle\">omega</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-2\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>Texte 2</p>\n<aside class=\"notes\"><p>This is a speaker note, it is only visible in the speaker view.</p>\n<style type=\"text/css\">\n        span.MJX_Assistive_MathML {\n          position:absolute!important;\n          clip: rect(1px, 1px, 1px, 1px);\n          padding: 1px 0 0 0!important;\n          border: 0!important;\n          height: 1px!important;\n          width: 1px!important;\n          overflow: hidden!important;\n          display:block!important;\n      }</style></aside></section>\n<section id=\"slide-2-1\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>{tidyr} image</p>\n<p><img data-src=\"img/logo_2.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Deuxi√®me Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>\n<section id=\"title-slide-3\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Troisi√®me Chapitre</h1>\n  <p class=\"subtitle\">youpi</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-3\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>Texte 3</p>\n</section>\n<section id=\"slide-3-1\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>{ggplot2} image</p>\n<p><img data-src=\"img/logo_1.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Troisi√®me Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>",
      html = TRUE,
      class = c("html",
                "character")
    )
  )
  
  # test with three htmls in order 2-1-3
  html_slide_content_reordered <- extract_html_slides(vec_html_path = htmls[c(2, 1, 3)])
  
  expect_equal(
    object = html_slide_content_reordered,
    expected = structure(
      "<section id=\"title-slide-1\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Deuxi√®me Chapitre</h1>\n  <p class=\"subtitle\">omega</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-2\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>Texte 2</p>\n<aside class=\"notes\"><p>This is a speaker note, it is only visible in the speaker view.</p>\n<style type=\"text/css\">\n        span.MJX_Assistive_MathML {\n          position:absolute!important;\n          clip: rect(1px, 1px, 1px, 1px);\n          padding: 1px 0 0 0!important;\n          border: 0!important;\n          height: 1px!important;\n          width: 1px!important;\n          overflow: hidden!important;\n          display:block!important;\n      }</style></aside></section>\n<section id=\"slide-2-1\" class=\"slide level2\"><h2>Slide 2</h2>\n<p>{tidyr} image</p>\n<p><img data-src=\"img/logo_2.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Deuxi√®me Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>\n<section id=\"title-slide-2\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Premier Chapitre</h1>\n  <p class=\"subtitle\">alpha</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>An example code chunk</p>\n<div class=\"cell\">\n<div class=\"sourceCode cell-code\" id=\"cb1\"><pre class=\"sourceCode numberSource r number-lines code-with-copy\"><code class=\"sourceCode r\"><span id=\"cb1-1\"><a href=\"#cb1-1\"></a><span class=\"dv\">8</span> <span class=\"sc\">*</span> <span class=\"dv\">8</span></span></code><button title=\"Copy to Clipboard\" class=\"code-copy-button\"><i class=\"bi\"></i></button></pre></div>\n<div class=\"cell-output cell-output-stdout\">\n<pre><code>[1] 64</code></pre>\n</div>\n</div>\n</section>\n<section id=\"slide-1-1\" class=\"slide level2\"><h2>Slide 1</h2>\n<p>{dplyr} image</p>\n<p><img data-src=\"img/logo_1.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Premier Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>\n<section id=\"title-slide-3\" data-background-image=\"../../_extensions/ThinkR-open/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Troisi√®me Chapitre</h1>\n  <p class=\"subtitle\">youpi</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>\n<section id=\"slide-3\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>Texte 3</p>\n</section>\n<section id=\"slide-3-1\" class=\"slide level2\"><h2>Slide 3</h2>\n<p>{ggplot2} image</p>\n<p><img data-src=\"img/logo_1.png\"></p>\n<p><img src=\"../../_extensions/ThinkR-open/thinkridentity/logo.png\" class=\"slide-logo\"></p>\n<div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Troisi√®me Chapitre</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>",
      html = TRUE,
      class = c("html",
                "character")
    )
  )
  
  # clean up
  unlink(temp_dir, recursive = TRUE)
})
```

## `create_template_html()` : create a template html with ThinkR styling

Use the quakr extension to render html.

```{r function-create_template_html}
#' create_template_html
#' 
#' Create a template html with ThinkR styling
#' 
#' @param path_to_qmd character. Path to the qmd template to be rendered in thinkridentity-revealjs
#' @param output_file character. Name of the output html template
#' @param temp_dir character. Path to the temp_dir where template will be rendered
#' 
#' @inheritParams compile_qmd_course
#' 
#' @importFrom quarto quarto_render
#' @importFrom utils download.file unzip
#' @importFrom yaml write_yaml
#'
#' @return character. Path to the html template
#' 
#' @export
create_template_html <- function(
  path_to_qmd,
  output_file,
  output_dir,
  title = "Formation R",
  date = '01/01/01-01/01/01',
  temp_dir = tempfile(pattern = "template")
  ){
    
  # set qmd file name base on html output name
  output_file_qmd <- gsub("\\.html", "\\.qmd", output_file)
  
  # copy qmd template to temp_dir with new name
  if (!file.exists(temp_dir)){
    dir.create(temp_dir)
  }
  
  file.copy(
    from = path_to_qmd,
    to = file.path(
      temp_dir,
      output_file_qmd)
    )
  
  # download quakr _extensions from GitHub to temp_dir
  download.file(
    url = "https://github.com/ThinkR-open/quakr/archive/refs/heads/main.zip",
    destfile = file.path(temp_dir, "quakr.zip"),
    quiet = TRUE
    )

  if (!file.exists(file.path(temp_dir, "quakr.zip"))){
    stop("Thinkr-open/quakr zip was not properly downloaded.")
  }
    
  unzip(
    zipfile = file.path(temp_dir, "quakr.zip"),
    exdir = file.path(temp_dir, "quakr")
    )
  
  dir.create(file.path(temp_dir, "_extensions/"))
  
  file.copy(
    from = file.path(temp_dir, "quakr", "quakr-main", "_extensions/."),
    to = file.path(temp_dir, "_extensions"),
    recursive = TRUE)
  
  # define quarto project parameters
  write_yaml(
    x = list(
      "title" = title,
      "subtitle" = date,
      "format" = "thinkridentity-revealjs"
      ),
    file = file.path(temp_dir, "_quarto.yml")
  )
  
  # render template with parameters of quarto project
  quarto_render(
    input = file.path(temp_dir, output_file_qmd),
    quiet = TRUE)
  
  # copy output html and companion folders to output_dir
  files_to_copy <- c(
    "html" = file.path(temp_dir, output_file),
    "lib_folder" = file.path(temp_dir, gsub("\\.html", "_files", output_file)),
    "ext_folder" = file.path(temp_dir, "_extensions")
  )
  
  if (!file.exists(output_dir)){
    dir.create(output_dir)
  }
  
  file.copy(
    from = files_to_copy,
    to = output_dir,
    recursive = TRUE
  )
  
  # remove temp_dir
  unlink(temp_dir, recursive = TRUE)
  
  # return path to html template
  return(file.path(output_dir, output_file))
}
```
  
```{r example-create_template_html}
# create temp dir
temp_dir <- tempfile(pattern = "template")

# create html template
path_to_html_template <- create_template_html(
  path_to_qmd = system.file("template.qmd", package = "nq1h"),
  output_dir = temp_dir,
  output_file = "complete_course.html"
)

# clean up
unlink(temp_dir, recursive = TRUE)
```
  
```{r tests-create_template_html}
test_that("create_template_html works", {
  # create temp dir
  temp_dir <- tempfile(pattern = "template")
  
  # create html template
  path_to_html_template <- create_template_html(
    path_to_qmd = system.file("template.qmd", package = "nq1h"),
    output_dir = temp_dir,
    output_file = "complete_course.html"
  )

  # test extension dir is correctly copied
  expect_extension_files <- list.files(
      file.path(temp_dir, "_extensions"),
      recursive = TRUE
    )

  expect_setequal(
    object = expect_extension_files,
    expected = c(
      "thinkridentity/_extension.yml",
      "thinkridentity/background.png",
      "thinkridentity/logo.png",
      "thinkridentity/logo.svg",
      "thinkridentity/thinkridentity.scss"
    )
  )
  
  # test html content of template
  slide_content <- path_to_html_template |>
    read_html() |>
    html_elements(css = ".slides") |>
    html_children() |>
    as.character()
  
  expect_equal(
    object = slide_content,
    expected = c(
      "<section id=\"title-slide\" data-background-image=\"_extensions/thinkridentity/background.png\" class=\"quarto-title-block center\"><h1 class=\"title\">Formation R</h1>\n  <p class=\"subtitle\">01/01/01-01/01/01</p>\n\n<div class=\"quarto-title-authors\">\n</div>\n\n</section>",
      "<section class=\"slide level2\"><p>{{ include_html_content }}</p>\n</section>",
      "<section id=\"include_trainer\" class=\"slide level2\"><h2>{{ include_trainer }}</h2>\n<p><strong>{{ include_phone }}</strong></p>\n<p><strong>{{ include_mail }}</strong></p>\n\n<img src=\"_extensions/thinkridentity/logo.png\" class=\"slide-logo r-stretch\"><div class=\"footer footer-default\">\n<p><strong><i class=\"las la-book\"></i> Formation R</strong> | Retrouvez nous sur <a href=\"https://thinkr.fr\" class=\"uri\">https://thinkr.fr</a></p>\n</div>\n</section>"
    )
  )
  
  # clean up
  unlink(temp_dir, recursive = TRUE)
  
})
```


## `clean_rendering_files()` : cleanup course directory after rendering

Utility function to remove all the files and folders created when rendering a qmd. The files already present and updated will not be removed.
    
```{r function-clean_rendering_files}
#' clean_rendering_files
#' 
#' Remove all the files and folders created when rendering a qmd to html
#' 
#' @param dir character. The directory to look for rendering output recursively.
#' @param present_before character. Path to the files and directories present before rendering.
#' 
#' @return None. Side effect: remove files that were not present before rendering
#' 
#' @export
clean_rendering_files <- function(
    dir,
    present_before
){
    
  # list files
  present_after <- unique(
    list.files(
      path = dir,
      full.names = TRUE,
      recursive = TRUE,
      include.dirs = TRUE
    )
  )
  
  file_created_by_rendering <- setdiff(
    x = present_after,
    y = path.expand(present_before)
  )
  
  unlink(
    x = file_created_by_rendering,
    recursive = TRUE
  )
  
}
```
  
```{r example-clean_rendering_files}
# create a temp dir with qmd
temp_dir <- tempfile(pattern = "clean")

dir.create(
  path = file.path(temp_dir, "img"),
  recursive = TRUE
)

file.copy(
  from = system.file("courses", "C01", "qmd1_for_test.qmd", package = "nq1h"),
  to = temp_dir
)

file.copy(
  from = system.file("courses", "C01", "img", "logo_1.png", package = "nq1h"),
  to = file.path(temp_dir, "img")
)

# list files before rendering
file_and_dirs_before <- list.files(
  temp_dir,
  recursive = TRUE,
  full.names = TRUE,
  include.dirs = TRUE
)

# render qmd
quarto::quarto_render(
  input = file.path(temp_dir, "qmd1_for_test.qmd"),
  quiet = TRUE
)

# remove created files and dirs
clean_rendering_files(
  dir = temp_dir,
  present_before = file_and_dirs_before
)

# clean temp dir
unlink(temp_dir, recursive = TRUE)
```
  
```{r tests-clean_rendering_files}
test_that("clean_rendering_files works", {
  # create a temp dir with qmd
  temp_dir <- tempfile(pattern = "clean")
  
  dir.create(
    path = file.path(temp_dir, "img"),
    recursive = TRUE
  )
  
  file.copy(
    from = system.file("courses", "C01", "qmd1_for_test.qmd", package = "nq1h"),
    to = temp_dir
  )
  
  file.copy(
    from = system.file("courses", "C01", "img", "logo_1.png", package = "nq1h"),
    to = file.path(temp_dir, "img")
  )
  
  # list files before rendering
  file_and_dirs_before <- list.files(
    temp_dir,
    recursive = TRUE,
    full.names = TRUE,
    include.dirs = TRUE
  )
  
  # render qmd
  quarto::quarto_render(
    input = file.path(temp_dir, "qmd1_for_test.qmd"),
    quiet = TRUE
  )
  
  # remove created files and dirs
  clean_rendering_files(
    dir = temp_dir,
    present_before = file_and_dirs_before
  )
  
  # test list of files is the same before and after
  file_present_now <- list.files(
    temp_dir,
    recursive = TRUE,
    full.names = TRUE,
    include.dirs = TRUE
  )
  
  expect_setequal(
    object = file_present_now,
    expected = file_and_dirs_before)
  
  # clean temp dir
  unlink(temp_dir, recursive = TRUE)
})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_compile_qmd_course.Rmd",
  vignette_name = "Compile n qmd to html",
  check = FALSE,
  overwrite = TRUE
)
```