---
title: "flat_html_to_pdf.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# Convert html slides to pdf

In somes cases you might want to provide your audience with a slide deck in 
pdf format. The function `convert_html_to_pdf()` will come in handy it that case.

This function convert your html course to pdf using `decktape` a cli pdf exporter written in JavaScript. Credit to  https://github.com/astefanutti/decktape/.

To do so it uses the dockerised version of `decktape`. Behind the scene the 
function constructs the proper call to `docker run`.

It requires that:
* docker is installed on the system
* the user running the command is part of the docker group

```{r function-convert_html_to_pdf}
#' Convert a html presentation to pdf
#' 
#' This function is an interface to the dockerised version of `decktape`
#' a cli pdf exporter written in JavaScript. 
#' See  https://github.com/astefanutti/decktape/
#' 
#' It requires that:
#' * docker is installed on the system
#' * the user running the command is part of the docker group
#' 
#' @param html_path A character. Path to html file.
#' @param pdf_path A character. Path to pdf file.
#' @param debug_dry_run A logical. If TRUE the docker command string is returned without running it.
#' @param pause_before_slide_export A positive integer. Number of milliseconds to wait before to export each slide.
#'
#' @return Nothing. Used for its side effect.
#' 
#' @importFrom cli cat_rule
#' 
#' @export
convert_html_to_pdf <- function(
    html_path,
    pdf_path,
    pause_before_slide_export = 10,
    debug_dry_run = FALSE
) {

  stopifnot(
    file.exists(html_path)
  )  
  stopifnot(
    is.numeric(pause_before_slide_export) &&
      pause_before_slide_export > 0 
  )
  stopifnot(
    is.logical(debug_dry_run)
  )
  
  # Use absolute file paths so that docker command outcome
  # does not on current working directory
  html_path_directory <- normalizePath(
    dirname(html_path)
  )
  pdf_path_directory <- normalizePath(
    dirname(pdf_path)
  )
  
  docker_image <- "astefanutti/decktape"
  docker_command <- paste(
    "docker run --rm -t",
    # Directory where the pdf file will be saved
    sprintf("-v %s:/slides", pdf_path_directory),
    # Directory where the html file is
    sprintf("-v %s:/home/user", html_path_directory),
    docker_image,
    # html file name
    sprintf("/home/user/%s", basename(html_path)),
    # Pdf file name
    basename(pdf_path),
    # Time in ms before recording slide
    sprintf("--pause=%s", pause_before_slide_export)
  )
  
  if (
    isTRUE(debug_dry_run)
  ) {
    return(docker_command)
  }
  
  cat_rule(
    "Running external docker service: decktape"
  )
  system(docker_command)
}
```

```{r example-convert_html_to_pdf}
temp_dir <- tempfile(pattern = "compile")

courses_path <- system.file(
  "courses",
  package = "nq1h"
)
qmds <- list.files(
  path = courses_path,
  full.names = TRUE,
  recursive = TRUE,
  pattern = "qmd$"
)

html_output <- compile_qmd_course(
  vec_qmd_path = qmds,
  output_dir = temp_dir,
  output_html = "complete_course.html"
)

file_path <- list(
  html = file.path(temp_dir, "complete_course.html"),
  pdf = file.path(temp_dir, "complete_course.pdf")
)

convert_html_to_pdf(
  html_path = file_path$html,
  pdf_path = file_path$pdf
)

# browseURL(file_path$pdf)

unlink(temp_dir, TRUE, TRUE)
```

```{r tests-convert_html_to_pdf}
test_that("convert_html_to_pdf() produces a pdf", {
  
  skip_on_ci()
  
  temp_dir <- tempfile(pattern = "compile")
  
  courses_path <- system.file(
    "courses",
    package = "nq1h"
  )
  qmds <- list.files(
    path = courses_path,
    full.names = TRUE,
    recursive = TRUE,
    pattern = "qmd$"
  )
  
  html_output <- compile_qmd_course(
    vec_qmd_path = qmds,
    output_dir = temp_dir,
    output_html = "complete_course.html"
  )
  
  file_path <- list(
    html = file.path(temp_dir, "complete_course.html"),
    pdf = file.path(temp_dir, "complete_course.pdf")
  )
  
  convert_html_to_pdf(
    html_path = file_path$html,
    pdf_path = file_path$pdf
  )
  
  expect_true(
    file.exists(file_path$pdf)
  )
  
  unlink(temp_dir, TRUE, TRUE)
})

test_that("Error if html file does not exist", {
  expect_error(
    convert_html_to_pdf(
      html_path = "foo.html"
    )
  )
})

test_that("Error if debug_dry_run not a logical", {
  temp_html <- tempfile(fileext = ".html")
  file.create(temp_html)
  
  expect_error(
    convert_html_to_pdf(
      html_path = temp_html,
      pdf_path = "foo.pdf",
      debug_dry_run = "A String!"
    )
  )
  
  unlink(temp_html)
})

test_that("Error if pause_before_slide_export is not a positive number", {
    temp_html <- tempfile(fileext = ".html")
  file.create(temp_html)
  
  expect_error(
    convert_html_to_pdf(
      html_path = temp_html,
      pdf_path = "foo.pdf",
      pause_before_slide_export = TRUE
    )
  )
  
  unlink(temp_html)
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_html_to_pdf.Rmd", 
  vignette_name = "Convert html slides to pdf",
  open_vignette = FALSE,
  check = FALSE,
  overwrite = TRUE
)
```

